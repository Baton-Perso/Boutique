<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - PHONE&CO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --violet: #6f42c1; --dark: #333; --bg: #f0f2f5; --red: #dc3545; --green: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        .sidebar { width: 260px; background: white; height: 100vh; position: fixed; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); overflow-y: auto; }
        .main { margin-left: 300px; padding: 40px; width: calc(100% - 340px); }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h2 { color: var(--violet); border-left: 5px solid var(--violet); padding-left: 15px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select, textarea, button { padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; width: 100%; box-sizing: border-box; }
        button { background: var(--violet); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        .section-title { font-weight: 800; text-transform: uppercase; font-size: 11px; color: #888; margin-top: 25px; margin-bottom: 10px; display: block; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .admin-nav-item { display: block; padding: 10px; color: var(--dark); text-decoration: none; font-weight: 500; border-radius: 8px; transition: 0.2s; }
        .admin-nav-item:hover { background: #f3ebff; color: var(--violet); }
        .manage-list { max-height: 150px; overflow-y: auto; border: 1px solid #eee; background: #fff; border-radius: 8px; margin-top: 10px; padding: 5px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        .list-item:last-child { border-bottom: none; }
        .btn-del { color: var(--red); cursor: pointer; font-weight: bold; font-size: 16px; border: none; background: none; width: auto; padding: 0 5px; margin: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; text-align: left; padding: 12px; font-size: 12px; color: #666; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .faq-item-admin { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        .status-online { background: #e6ffed; color: var(--green); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .status-offline { background: #fff0f0; color: var(--red); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="admin-content" style="display: none; width: 100%;">
    <div class="sidebar">
        <h1 style="color:var(--violet); font-size: 22px;">PHONE&CO Admin</h1>
        <a href="index.html" class="admin-nav-item">‚Üê Voir le site</a>
        <p class="section-title">Boutique</p>
        <a href="#section-filtres-boutique" class="admin-nav-item">‚Ä¢ G√©rer Marques/Cat√©gories</a>
        <a href="#section-accessoires" class="admin-nav-item">‚Ä¢ Ajouter un Produit</a>
        <a href="#section-stock-manager" class="admin-nav-item">‚Ä¢ √âtat des Stocks</a>
        <p class="section-title">R√©parations</p>
        <a href="#section-reparations" class="admin-nav-item">‚Ä¢ Configurer les tarifs</a>
        <p class="section-title">Interactions</p>
        <a href="#section-faq" class="admin-nav-item">‚Ä¢ Mod√©rer la FAQ</a>
        <a href="#section-clients" class="admin-nav-item">‚Ä¢ Liste des Clients</a>
    </div>

    <div class="main">
        <div id="section-filtres-boutique" class="card">
            <h2>üõ†Ô∏è Param√®tres de la Boutique</h2>
            <div class="form-grid">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 12px;">
                    <p class="section-title">Marques d'accessoires</p>
                    <div style="display:flex; gap:5px;"><input type="text" id="new-prod-brand" placeholder="Ex: Belkin..."><button onclick="addFilter('product_brands', 'new-prod-brand')" style="width:50px; margin:0;">+</button></div>
                    <div id="list-brands" class="manage-list"></div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 12px;">
                    <p class="section-title">Cat√©gories d'accessoires</p>
                    <div style="display:flex; gap:5px;"><input type="text" id="new-prod-cat" placeholder="Ex: Coques..."><button onclick="addFilter('product_categories', 'new-prod-cat')" style="width:50px; margin:0;">+</button></div>
                    <div id="list-cats" class="manage-list"></div>
                </div>
            </div>
        </div>

        <div id="section-accessoires" class="card">
            <h2>üì¶ Ajouter un Produit / Accessoire</h2>
            <div class="form-grid">
                <input type="text" id="acc-name" placeholder="Titre du produit" style="grid-column: span 2;">
                <select id="acc-brand-select"><option value="">Chargement...</option></select>
                <select id="acc-cat-select"><option value="">Chargement...</option></select>
                <input type="number" step="0.01" id="acc-price" placeholder="Prix (‚Ç¨)">
                <input type="number" id="acc-stock" placeholder="Stock Initial">
                <input type="text" id="acc-img" placeholder="URL Photo" style="grid-column: span 2;">
            </div>
            <button onclick="addAccessory()" style="background:var(--green);">Enregistrer en boutique</button>
        </div>

        <div id="section-stock-manager" class="card">
            <h2>üìä √âtat des Stocks & Inventaire</h2>
            <table>
                <thead><tr><th>Produit</th><th>Cat√©gorie</th><th>Prix</th><th>Stock</th><th>Action</th></tr></thead>
                <tbody id="inventory-list-body"></tbody>
            </table>
        </div>

        <div id="section-faq" class="card">
            <h2>üí¨ Mod√©ration de la FAQ</h2>
            <div id="faq-admin-list"></div>
        </div>

        <div id="section-reparations" class="card">
            <h2>üîß Configuration des R√©parations</h2>
            <div class="form-grid">
                <div>
                    <p class="section-title">Marques & Mod√®les</p>
                    <input type="text" id="rep-brand-name" placeholder="Nom Marque">
                    <input type="text" id="rep-brand-logo" placeholder="URL Logo" style="margin-top:10px;">
                    <button onclick="addRepairBrand()">Ajouter Marque</button>
                    <div id="list-repair-brands" class="manage-list"></div>
                    
                    <select id="select-brand-for-model" style="margin-top:20px;"><option>Chargement...</option></select>
                    <input type="text" id="rep-model-name" placeholder="Nom Mod√®le" style="margin-top:10px;">
                    <input type="text" id="rep-model-img" placeholder="URL Photo" style="margin-top:10px;">
                    <button onclick="addRepairModel()">Ajouter Mod√®le</button>
                </div>
                <div>
                    <p class="section-title">Tarifs par type de panne</p>
                    <select id="select-model-for-repair"><option value="">Choisir un mod√®le...</option></select>
                    <input type="text" id="repair-type-input" placeholder="Ex: √âcran, Batterie..." style="margin-top:10px;">
                    <input type="number" id="repair-price-input" placeholder="Prix en ‚Ç¨" style="margin-top:10px;">
                    <button onclick="addRepairPrice()" style="background:var(--violet);">Enregistrer ce tarif</button>
                    <p class="section-title">Liste des tarifs</p>
                    <div id="list-repair-prices" class="manage-list" style="max-height: 250px;"></div>
                </div>
            </div>
        </div>

        <div id="section-clients" class="card">
            <h2>üë• Liste des Clients inscrits</h2>
            <table>
                <thead><tr><th>Email</th><th>Date d'inscription</th><th>Actions</th></tr></thead>
                <tbody id="client-list-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://rryfiyupsmdqranvuqmx.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeWZpeXVwc21kcXJhbnZ1cW14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDU5MTcsImV4cCI6MjA4NjgyMTkxN30.JzzAt3ejHhg66unhyw9Fc_uvlvtgJ4h7Pss5TUupD3g";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    async function init() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { window.location.href = "login.html"; return; }
        const { data: profile } = await supabaseClient.from('profiles').select('is_admin').eq('id', user.id).single();
        if (!profile?.is_admin) { window.location.href = "index.html"; return; }

        document.getElementById('admin-content').style.display = 'flex';
        
        loadRepairBrands();
        loadRepairModels(); 
        loadRepairPrices(); 
        loadProductFilters();
        loadClients();
        loadInventory();
        loadFAQAdmin();
    }

    // --- FAQ ---
    async function loadFAQAdmin() {
        const { data } = await supabaseClient.from('faq').select('*').order('created_at', { ascending: false });
        document.getElementById('faq-admin-list').innerHTML = data?.map(f => `
            <div class="faq-item-admin">
                <span class="${f.is_visible ? 'status-online' : 'status-offline'}">${f.is_visible ? 'Visible' : 'Masqu√©e'}</span>
                <p><strong>Q:</strong> ${f.question}</p>
                <textarea id="resp-${f.id}">${f.reponse || ''}</textarea>
                <button onclick="updateFAQ(${f.id})">Enregistrer</button>
                <button onclick="deleteFAQ(${f.id})" style="background:var(--red)">Supprimer</button>
            </div>`).join('') || "Aucune question.";
    }
    async function updateFAQ(id) {
        const reponse = document.getElementById(`resp-${id}`).value;
        await supabaseClient.from('faq').update({ reponse, is_visible: true }).eq('id', id);
        loadFAQAdmin();
    }
    async function deleteFAQ(id) { if(confirm("Supprimer ?")) { await supabaseClient.from('faq').delete().eq('id', id); loadFAQAdmin(); } }

    // --- INVENTAIRE ---
    async function loadInventory() {
        const { data } = await supabaseClient.from('products').select('*').order('name');
        document.getElementById('inventory-list-body').innerHTML = data?.map(p => `
            <tr>
                <td>${p.name}</td><td>${p.category}</td><td>${p.price}‚Ç¨</td>
                <td><input type="number" id="stk-${p.id}" value="${p.stock}" style="width:60px"></td>
                <td><button onclick="updateStock(${p.id})">OK</button></td>
            </tr>`).join('');
    }
    async function updateStock(id) {
        const stock = document.getElementById(`stk-${id}`).value;
        await supabaseClient.from('products').update({ stock: parseInt(stock) }).eq('id', id);
        loadInventory();
    }

    // --- REPARATIONS (MODIFI√â POUR TA TABLE) ---
    async function loadRepairBrands() {
        const { data } = await supabaseClient.from('repair_brands').select('*').order('name');
        const select = document.getElementById('select-brand-for-model');
        select.innerHTML = '<option value="">Choisir marque...</option>';
        data?.forEach(b => select.innerHTML += `<option value="${b.id}">${b.name}</option>`);
        document.getElementById('list-repair-brands').innerHTML = data?.map(b => `<div class="list-item">${b.name} <button class="btn-del" onclick="deleteItem('repair_brands', ${b.id})">√ó</button></div>`).join('');
    }

    async function loadRepairModels() {
        const { data } = await supabaseClient.from('repair_models').select('*').order('name');
        const select = document.getElementById('select-model-for-repair');
        select.innerHTML = '<option value="">Choisir mod√®le...</option>';
        data?.forEach(m => select.innerHTML += `<option value="${m.id}">${m.name}</option>`);
    }

    async function loadRepairPrices() {
        const { data } = await supabaseClient.from('repair_types').select('*, repair_models(name)').order('created_at', {ascending: false});
        document.getElementById('list-repair-prices').innerHTML = data?.map(p => `
            <div class="list-item">
                <span>[${p.repair_models?.name}] ${p.name} : <b>${p.price}‚Ç¨</b></span>
                <button class="btn-del" onclick="deleteItem('repair_types', ${p.id})">√ó</button>
            </div>`).join('') || "Aucun tarif.";
    }

    async function addRepairPrice() {
        const model_id = document.getElementById('select-model-for-repair').value;
        const name = document.getElementById('repair-type-input').value;
        const price = parseFloat(document.getElementById('repair-price-input').value);
        if(!model_id || !name || isNaN(price)) return alert("Remplissez tout !");
        
        // On ins√®re model_id, name, price ET default_price (qui est identique au prix de base)
        await supabaseClient.from('repair_types').insert([{ model_id, name, price, default_price: price }]);
        loadRepairPrices();
    }

    async function addRepairBrand() {
        await supabaseClient.from('repair_brands').insert([{ name: document.getElementById('rep-brand-name').value, logo_url: document.getElementById('rep-brand-logo').value }]);
        loadRepairBrands();
    }

    async function addRepairModel() {
        await supabaseClient.from('repair_models').insert([{ 
            brand_id: document.getElementById('select-brand-for-model').value,
            name: document.getElementById('rep-model-name').value,
            image_url: document.getElementById('rep-model-img').value
        }]);
        loadRepairModels();
    }

    // --- CLIENTS & FILTRES ---
    async function loadProductFilters() {
        const { data: b } = await supabaseClient.from('product_brands').select('*');
        const { data: c } = await supabaseClient.from('product_categories').select('*');
        document.getElementById('acc-brand-select').innerHTML = b?.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
        document.getElementById('acc-cat-select').innerHTML = c?.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
    }
    async function addFilter(table, id) {
        const name = document.getElementById(id).value;
        if(name) { await supabaseClient.from(table).insert([{name}]); loadProductFilters(); }
    }
    async function addAccessory() {
        await supabaseClient.from('products').insert([{
            name: document.getElementById('acc-name').value,
            brand: document.getElementById('acc-brand-select').value,
            price: parseFloat(document.getElementById('acc-price').value),
            category: document.getElementById('acc-cat-select').value,
            stock: parseInt(document.getElementById('acc-stock').value) || 0,
            image_url: document.getElementById('acc-img').value
        }]);
        loadInventory();
    }
    async function loadClients() {
        const { data } = await supabaseClient.from('profiles').select('*');
        document.getElementById('client-list-body').innerHTML = data?.map(c => `<tr><td>${c.email}</td><td>${new Date(c.created_at).toLocaleDateString()}</td><td>Supprimer</td></tr>`).join('');
    }
    async function deleteItem(table, id) {
        if(confirm("Supprimer ?")) { 
            await supabaseClient.from(table).delete().eq('id', id);
            loadRepairBrands(); loadRepairModels(); loadRepairPrices(); loadProductFilters();
        }
    }

    init();
</script>
</body>
</html>
