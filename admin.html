<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - PHONE&CO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --violet: #6f42c1; --dark: #333; --bg: #f0f2f5; --red: #dc3545; --green: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        .sidebar { width: 260px; background: white; height: 100vh; position: fixed; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); overflow-y: auto; }
        .main { margin-left: 300px; padding: 40px; width: calc(100% - 340px); }
        
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h2 { color: var(--violet); border-left: 5px solid var(--violet); padding-left: 15px; margin-bottom: 20px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        button { background: var(--violet); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .section-title { font-weight: 800; text-transform: uppercase; font-size: 11px; color: #888; margin-top: 25px; margin-bottom: 10px; display: block; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .admin-nav-item { display: block; padding: 10px; color: var(--dark); text-decoration: none; font-weight: 500; border-radius: 8px; transition: 0.2s; }
        .admin-nav-item:hover { background: #f3ebff; color: var(--violet); }

        .manage-list { max-height: 150px; overflow-y: auto; border: 1px solid #eee; background: #fff; border-radius: 8px; margin-top: 10px; padding: 5px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        .list-item:last-child { border-bottom: none; }
        .btn-del { color: var(--red); cursor: pointer; font-weight: bold; font-size: 16px; border: none; background: none; width: auto; padding: 0 5px; margin: 0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; text-align: left; padding: 12px; font-size: 12px; color: #666; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }

        .badge-low { background: #fff0f0; color: var(--red); padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

<div id="admin-content" style="display: none; width: 100%;">
    <div class="sidebar">
        <h1 style="color:var(--violet); font-size: 22px;">PHONE&CO Admin</h1>
        <a href="index.html" class="admin-nav-item">‚Üê Voir le site</a>
        
        <p class="section-title">Boutique</p>
        <a href="#section-filtres-boutique" class="admin-nav-item">‚Ä¢ G√©rer Marques/Cat√©gories</a>
        <a href="#section-accessoires" class="admin-nav-item">‚Ä¢ Ajouter un Produit</a>
        <a href="#section-stock-manager" class="admin-nav-item">‚Ä¢ √âtat des Stocks</a>
        
        <p class="section-title">R√©parations</p>
        <a href="#section-reparations" class="admin-nav-item">‚Ä¢ Configurer les tarifs</a>

        <p class="section-title">Utilisateurs</p>
        <a href="#section-clients" class="admin-nav-item">‚Ä¢ Liste des Clients</a>
    </div>

    <div class="main">
        <div id="section-filtres-boutique" class="card">
            <h2>üõ†Ô∏è Param√®tres de la Boutique</h2>
            <div class="form-grid">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 12px;">
                    <p class="section-title">Marques d'accessoires</p>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-prod-brand" placeholder="Ex: Belkin...">
                        <button onclick="addFilter('product_brands', 'new-prod-brand')" style="width:50px; margin:0;">+</button>
                    </div>
                    <div id="list-brands" class="manage-list"></div>
                </div>

                <div style="background: #f9f9f9; padding: 15px; border-radius: 12px;">
                    <p class="section-title">Cat√©gories d'accessoires</p>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-prod-cat" placeholder="Ex: Coques...">
                        <button onclick="addFilter('product_categories', 'new-prod-cat')" style="width:50px; margin:0;">+</button>
                    </div>
                    <div id="list-cats" class="manage-list"></div>
                </div>
            </div>
        </div>

        <div id="section-accessoires" class="card">
            <h2>üì¶ Ajouter un Produit / Accessoire</h2>
            <div class="form-grid">
                <input type="text" id="acc-name" placeholder="Titre du produit" style="grid-column: span 2;">
                <select id="acc-brand-select"><option value="">Chargement...</option></select>
                <select id="acc-cat-select"><option value="">Chargement...</option></select>
                <input type="number" step="0.01" id="acc-price" placeholder="Prix (‚Ç¨)">
                <input type="number" id="acc-stock" placeholder="Stock Initial">
                <input type="text" id="acc-img" placeholder="URL Photo" style="grid-column: span 2;">
            </div>
            <button onclick="addAccessory()" style="background:var(--green);">Enregistrer en boutique</button>
        </div>

        <div id="section-stock-manager" class="card">
            <h2>üìä √âtat des Stocks & Inventaire</h2>
            <p class="section-title">Inventaire en temps r√©el</p>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Cat√©gorie</th>
                            <th>Prix</th>
                            <th>Stock</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="section-reparations" class="card">
            <h2>üîß Configuration des R√©parations</h2>
            <p class="section-title">√âtape 1 : G√©rer les Marques de t√©l√©phones</p>
            <div class="form-grid">
                <div>
                    <input type="text" id="rep-brand-name" placeholder="Nom (Apple...)">
                    <input type="text" id="rep-brand-logo" placeholder="URL Logo" style="margin-top:10px;">
                    <button onclick="addRepairBrand()">Ajouter la Marque</button>
                </div>
                <div id="list-repair-brands" class="manage-list"></div>
            </div>

            <p class="section-title">√âtape 2 : Ajouter un Mod√®le</p>
            <div class="form-grid">
                <select id="select-brand-for-model"><option>Chargement...</option></select>
                <input type="text" id="rep-model-name" placeholder="iPhone 14 Pro">
                <input type="text" id="rep-model-img" placeholder="URL Photo" style="grid-column: span 2;">
            </div>
            <button onclick="addRepairModel()">Ajouter le Mod√®le</button>

            <p class="section-title">√âtape 3 : Ajouter une Panne & Prix</p>
            <div class="form-grid">
                <input type="text" id="rep-type-name" placeholder="Type (√âcran LCD...)">
                <input type="number" step="0.01" id="rep-type-price" placeholder="Prix (‚Ç¨)">
            </div>
            <button onclick="addRepairType()">Enregistrer la Panne</button>
        </div>

        <div id="section-clients" class="card">
            <h2>üë• Liste des Clients inscrits</h2>
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Date d'inscription</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="client-list-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://rryfiyupsmdqranvuqmx.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeWZpeXVwc21kcXJhbnZ1cW14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDU5MTcsImV4cCI6MjA4NjgyMTkxN30.JzzAt3ejHhg66unhyw9Fc_uvlvtgJ4h7Pss5TUupD3g";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    async function init() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        if (!user) {
            window.location.href = "login.html";
            return;
        }

        const { data: profile, error: profileError } = await supabaseClient
            .from('profiles')
            .select('is_admin')
            .eq('id', user.id)
            .single();

        if (profileError || !profile || !profile.is_admin) {
            alert("Acc√®s refus√©.");
            window.location.href = "index.html";
            return;
        }

        document.getElementById('admin-content').style.display = 'flex';
        
        loadRepairBrands();
        loadProductFilters();
        loadClients();
        loadInventory();
    }

    // --- GESTION INVENTAIRE ---
    async function loadInventory() {
        const { data: products, error } = await supabaseClient
            .from('products')
            .select('*')
            .order('name');

        const body = document.getElementById('inventory-list-body');
        if (error) return;

        body.innerHTML = products.map(p => {
            const isLow = p.stock <= 2;
            return `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.category}</td>
                    <td>${p.price.toFixed(2)} ‚Ç¨</td>
                    <td>
                        <input type="number" id="stock-input-${p.id}" value="${p.stock}" 
                               style="width:70px; padding:5px; border:${isLow ? '2px solid var(--red)' : '1px solid #ddd'}">
                        ${isLow ? '<br><span class="badge-low">Bas</span>' : ''}
                    </td>
                    <td>
                        <button onclick="updateStock(${p.id})" style="width:auto; margin:0; padding:5px 12px; font-size:12px;">OK</button>
                    </td>
                </tr>
            `;
        }).join('') || `<tr><td colspan="5">Aucun produit.</td></tr>`;
    }

    async function updateStock(productId) {
        const newVal = document.getElementById(`stock-input-${productId}`).value;
        const { error } = await supabaseClient
            .from('products')
            .update({ stock: parseInt(newVal) })
            .eq('id', productId);

        if (error) alert(error.message);
        else loadInventory();
    }

    // --- LOGIQUE CLIENTS ---
    async function loadClients() {
        const { data, error } = await supabaseClient.from('profiles').select('*').order('created_at', { ascending: false });
        const body = document.getElementById('client-list-body');
        if (error) return;

        body.innerHTML = data.map(c => `
            <tr>
                <td><strong>${c.email}</strong> ${c.is_admin ? '<span style="color:var(--violet); font-size:10px;">[ADMIN]</span>' : ''}</td>
                <td>${new Date(c.created_at).toLocaleDateString('fr-FR')}</td>
                <td>
                    ${!c.is_admin ? `<button onclick="deleteClient('${c.id}')" style="background:none; color:var(--red); width:auto; margin:0; padding:5px;">Supprimer</button>` : ''}
                </td>
            </tr>
        `).join('') || `<tr><td colspan="3">Aucun client trouv√©.</td></tr>`;
    }

    async function deleteClient(id) {
        if(confirm("Supprimer ce profil client ?")){
            const { error } = await supabaseClient.from('profiles').delete().eq('id', id);
            if(!error) loadClients();
        }
    }

    // --- LOGIQUE BOUTIQUE & R√âPARATIONS ---
    async function loadProductFilters() {
        const { data: brands } = await supabaseClient.from('product_brands').select('*').order('name');
        const { data: cats } = await supabaseClient.from('product_categories').select('*').order('name');
        const bSelect = document.getElementById('acc-brand-select');
        const cSelect = document.getElementById('acc-cat-select');
        const bList = document.getElementById('list-brands');
        const cList = document.getElementById('list-cats');

        bSelect.innerHTML = '<option value="">Marque...</option>';
        brands?.forEach(b => bSelect.innerHTML += `<option value="${b.name}">${b.name}</option>`);
        cSelect.innerHTML = '<option value="">Cat√©gorie...</option>';
        cats?.forEach(c => cSelect.innerHTML += `<option value="${c.name}">${c.name}</option>`);

        bList.innerHTML = brands?.map(b => `<div class="list-item">${b.name} <button class="btn-del" onclick="deleteItem('product_brands', ${b.id})">√ó</button></div>`).join('');
        cList.innerHTML = cats?.map(c => `<div class="list-item">${c.name} <button class="btn-del" onclick="deleteItem('product_categories', ${c.id})">√ó</button></div>`).join('');
    }

    async function loadRepairBrands() {
        const { data } = await supabaseClient.from('repair_brands').select('*').order('name');
        const select = document.getElementById('select-brand-for-model');
        const list = document.getElementById('list-repair-brands');
        select.innerHTML = '<option value="">Marque...</option>';
        data?.forEach(b => select.innerHTML += `<option value="${b.id}">${b.name}</option>`);
        list.innerHTML = data?.map(b => `<div class="list-item">${b.name} <button class="btn-del" onclick="deleteItem('repair_brands', ${b.id})">√ó</button></div>`).join('');
    }

    async function addFilter(table, inputId) {
        const name = document.getElementById(inputId).value;
        if(!name) return;
        const { error } = await supabaseClient.from(table).insert([{ name }]);
        if (!error) { document.getElementById(inputId).value = ""; loadProductFilters(); }
    }

    async function addRepairBrand() {
        const name = document.getElementById('rep-brand-name').value;
        const logo = document.getElementById('rep-brand-logo').value;
        const { error } = await supabaseClient.from('repair_brands').insert([{ name, logo_url: logo }]);
        if (!error) { document.getElementById('rep-brand-name').value = ""; loadRepairBrands(); }
    }

    async function deleteItem(table, id) {
        if (!confirm("Supprimer cet √©l√©ment ?")) return;
        const { error } = await supabaseClient.from(table).delete().eq('id', id);
        if (error) alert("Erreur : Liaison existante."); else { loadProductFilters(); loadRepairBrands(); }
    }

    async function addAccessory() {
        const { error } = await supabaseClient.from('products').insert([{
            name: document.getElementById('acc-name').value,
            brand: document.getElementById('acc-brand-select').value,
            price: parseFloat(document.getElementById('acc-price').value),
            category: document.getElementById('acc-cat-select').value,
            stock: parseInt(document.getElementById('acc-stock').value) || 0,
            image_url: document.getElementById('acc-img').value
        }]);
        if (error) alert(error.message); 
        else { 
            alert("Produit ajout√© !"); 
            loadInventory(); // On rafra√Æchit l'inventaire
        }
    }

    async function addRepairModel() {
        const { error } = await supabaseClient.from('repair_models').insert([{ 
            brand_id: document.getElementById('select-brand-for-model').value,
            name: document.getElementById('rep-model-name').value,
            image_url: document.getElementById('rep-model-img').value
        }]);
        if (!error) alert("Mod√®le ajout√© !");
    }

    async function addRepairType() {
        const { error } = await supabaseClient.from('repair_types').insert([{ 
            name: document.getElementById('rep-type-name').value,
            price: parseFloat(document.getElementById('rep-type-price').value)
        }]);
        if (!error) alert("Panne enregistr√©e !");
    }

    init();
</script>
</body>
</html>
