<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessoires - PHONE&CO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --violet: #6f42c1; --dark: #333; --light: #f4f7f6; --success: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; overflow-x: hidden; }

        /* --- NAVBAR VIOLETTE --- */
        nav { 
            background: var(--violet); 
            padding: 15px 5%; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }
        .logo { font-weight: 800; font-size: 24px; text-decoration: none; color: white; letter-spacing: 1px; }
        .nav-links { display: flex; gap: 25px; align-items: center; }
        .nav-links a { 
            text-decoration: none; 
            color: rgba(255,255,255,0.9); 
            font-weight: 600; 
            font-size: 13px; 
            text-transform: uppercase; 
            transition: 0.3s;
        }
        .nav-links a:hover { color: white; }
        
        .btn-admin { 
            background: white; 
            color: var(--violet) !important; 
            padding: 8px 18px; 
            border-radius: 8px; 
            font-weight: bold !important;
            text-transform: uppercase;
            font-size: 12px;
        }

        /* --- PANIER (Nouveau) --- */
        .cart-trigger { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: bold; 
            position: relative;
            border: 1px solid rgba(255,255,255,0.3);
        }
        #cart-count { background: #ff4757; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: absolute; top: -5px; right: -5px; }

        .cart-sidebar { position: fixed; right: -400px; top: 0; width: 350px; height: 100%; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2000; transition: 0.4s; display: flex; flex-direction: column; }
        .cart-sidebar.active { right: 0; }
        .cart-header { padding: 20px; background: var(--violet); color: white; display: flex; justify-content: space-between; align-items: center; }
        .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .cart-item { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .cart-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        .cart-footer { padding: 20px; border-top: 1px solid #eee; background: #fafafa; }
        .btn-order-final { width: 100%; background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-order-final:hover { background: #218838; }

        /* Filtres */
        .filter-bar { background: white; padding: 20px 5%; display: flex; gap: 20px; flex-wrap: wrap; border-bottom: 1px solid #eee; }
        select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; min-width: 150px; outline: none; }
        select:focus { border-color: var(--violet); }

        /* Grille produits */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
        .product-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s; display: flex; flex-direction: column; }
        .product-card:hover { transform: translateY(-5px); }
        .product-card img { width: 100%; height: 200px; object-fit: cover; }
        .product-info { padding: 15px; flex-grow: 1; }
        .product-info h3 { margin: 5px 0; font-size: 16px; color: var(--dark); }
        .product-info .brand { font-size: 11px; color: var(--violet); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .product-info .price { color: var(--dark); font-weight: 800; font-size: 20px; margin-top: 10px; display: block; }
        .add-btn { width: 100%; background: var(--violet); color: white; border: none; padding: 12px; margin-top: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .add-btn:hover { opacity: 0.9; }

        /* Modale */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; }
        .modal-content h2 { margin-top: 0; color: var(--violet); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-save { flex: 1; background: var(--violet); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-cancel { flex: 1; background: #ccc; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">PHONE&CO</a>
        <div class="nav-links" id="nav-menu"></div>
        <div class="cart-trigger" onclick="toggleCart()">
            üõí Panier <span id="cart-count">0</span>
        </div>
    </nav>

    <div id="cart-sidebar" class="cart-sidebar">
        <div class="cart-header">
            <h3>Mon Panier</h3>
            <button onclick="toggleCart()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="cart-items-list" class="cart-items">
            </div>
        <div class="cart-footer">
            <h3 id="cart-total-price" style="margin-bottom:15px; color:var(--dark);">Total : 0.00 ‚Ç¨</h3>
            <button class="btn-order-final" onclick="checkout()">PASSER LA COMMANDE</button>
        </div>
    </div>

    <div class="filter-bar">
        <select id="filter-brand" onchange="loadProducts()">
            <option value="">Toutes les marques</option>
        </select>
        <select id="filter-category" onchange="loadProducts()">
            <option value="">Toutes les cat√©gories</option>
        </select>
    </div>

    <main class="container">
        <div class="product-grid" id="product-container"></div>
    </main>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Modifier le produit</h2>
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label>Nom du produit</label>
                <input type="text" id="edit-name">
            </div>
            <div class="form-group">
                <label>Prix (‚Ç¨)</label>
                <input type="number" step="0.01" id="edit-price">
            </div>
            <div class="form-group">
                <label>URL Image</label>
                <input type="text" id="edit-image">
            </div>
            <div class="modal-btns">
                <button class="btn-save" onclick="saveEdit()">Enregistrer</button>
                <button class="btn-cancel" onclick="closeModal()">Annuler</button>
            </div>
        </div>
    </div>

    // --- REMPLACE TOUTE LA PARTIE SCRIPT PAR CELLE-CI ---
<script>
    const SB_URL = "https://rryfiyupsmdqranvuqmx.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeWZpeXVwc21kcXJhbnZ1cW14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDU5MTcsImV4cCI6MjA4NjgyMTkxN30.JzzAt3ejHhg66unhyw9Fc_uvlvtgJ4h7Pss5TUupD3g";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let cart = JSON.parse(localStorage.getItem('phoneco_cart')) || [];

    // --- NOUVELLE FONCTION DE V√âRIFICATION ADMIN S√âCURIS√âE ---
    async function getAdminStatus(user) {
        if (!user) return false;
        const { data } = await supabaseClient
            .from('profiles')
            .select('is_admin')
            .eq('id', user.id)
            .single();
        return data ? data.is_admin : false;
    }

    // --- GESTION DU PANIER ---
    function toggleCart() {
        document.getElementById('cart-sidebar').classList.toggle('active');
    }

    function addToCart(pJson) {
        const product = JSON.parse(decodeURIComponent(pJson));
        cart.push(product);
        localStorage.setItem('phoneco_cart', JSON.stringify(cart));
        updateCartUI();
        if(!document.getElementById('cart-sidebar').classList.contains('active')) toggleCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        localStorage.setItem('phoneco_cart', JSON.stringify(cart));
        updateCartUI();
    }

    function updateCartUI() {
        const list = document.getElementById('cart-items-list');
        const count = document.getElementById('cart-count');
        const totalDisplay = document.getElementById('cart-total-price');
        
        list.innerHTML = "";
        let total = 0;

        cart.forEach((item, index) => {
            total += item.price;
            list.innerHTML += `
                <div class="cart-item">
                    <img src="${item.image_url || 'https://via.placeholder.com/50'}">
                    <div style="flex-grow:1;">
                        <div style="font-weight:bold; font-size:13px;">${item.name}</div>
                        <div style="color:var(--violet); font-weight:bold;">${item.price.toFixed(2)} ‚Ç¨</div>
                    </div>
                    <button onclick="removeFromCart(${index})" style="background:none; border:none; color:#ff4757; cursor:pointer; font-size:18px;">&times;</button>
                </div>`;
        });

        count.innerText = cart.length;
        totalDisplay.innerText = `Total : ${total.toFixed(2)} ‚Ç¨`;
    }

    async function checkout() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            alert("üîí Vous devez √™tre connect√© pour commander !");
            window.location.href = "login.html";
            return;
        }
        if (cart.length === 0) { alert("Votre panier est vide."); return; }

        const total = cart.reduce((sum, item) => sum + item.price, 0);
        const details = cart.map(item => item.name).join(", ");

        const { error } = await supabaseClient.from('orders').insert([{
            user_id: user.id,
            details: "Panier Accessoires: " + details,
            total_price: total,
            status: 'En attente'
        }]);

        if (error) alert("Erreur : " + error.message);
        else {
            alert("‚úÖ Commande envoy√©e !");
            cart = [];
            localStorage.removeItem('phoneco_cart');
            updateCartUI();
            toggleCart();
        }
    }

    // --- CHARGEMENT FILTRES ---
    async function loadFilters() {
        const { data: brands } = await supabaseClient.from('product_brands').select('*');
        const brandSelect = document.getElementById('filter-brand');
        const currentBrand = brandSelect.value;
        brandSelect.innerHTML = '<option value="">Toutes les marques</option>';
        brands?.forEach(b => {
            brandSelect.innerHTML += `<option value="${b.name}" ${currentBrand === b.name ? 'selected' : ''}>${b.name}</option>`;
        });

        const { data: cats } = await supabaseClient.from('product_categories').select('*');
        const catSelect = document.getElementById('filter-category');
        const currentCat = catSelect.value;
        catSelect.innerHTML = '<option value="">Toutes les cat√©gories</option>';
        cats?.forEach(c => {
            catSelect.innerHTML += `<option value="${c.name}" ${currentCat === c.name ? 'selected' : ''}>${c.name}</option>`;
        });
    }

    // --- CHARGEMENT PRODUITS AVEC V√âRIF ADMIN ---
    async function loadProducts() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        // On v√©rifie le statut admin en base de donn√©es
        const isAdmin = await getAdminStatus(user);
        
        const menu = document.getElementById('nav-menu');
        let navHtml = `
            <a href="accessoires.html" style="color:white; border-bottom: 2px solid white; padding-bottom: 5px;">Accessoires</a>
            <a href="reparation.html">Reparation</a>
            <a href="contact.html">Contact</a>
        `;
        if (isAdmin) navHtml += `<a href="admin.html" class="btn-admin">Console Admin</a>`;
        navHtml += user ? `<a href="#" onclick="logout()">D√©connexion</a>` : `<a href="login.html">Connexion</a>`;
        menu.innerHTML = navHtml;

        await loadFilters();

        const brand = document.getElementById('filter-brand').value;
        const category = document.getElementById('filter-category').value;
        
        let query = supabaseClient.from('products').select('*');
        if (brand) query = query.eq('brand', brand);
        if (category) query = query.eq('category', category);

        const { data: products, error } = await query;
        const container = document.getElementById('product-container');
        container.innerHTML = error ? "<p>Erreur lors du chargement.</p>" : "";

        if (products) {
            products.forEach(p => {
                const pJson = encodeURIComponent(JSON.stringify(p));
                // Les boutons s'affichent si isAdmin est true (peu importe l'email)
                let adminButtons = isAdmin ? `
                    <div style="margin-top:10px; display:flex; gap:5px;">
                        <button onclick="deleteProduct(${p.id})" style="background:#d9534f; color:white; border:none; padding:8px; border-radius:5px; flex:1; cursor:pointer; font-weight:bold; font-size:11px;">Supprimer</button>
                        <button onclick="editProduct(${p.id})" style="background:#f0ad4e; color:white; border:none; padding:8px; border-radius:5px; flex:1; cursor:pointer; font-weight:bold; font-size:11px;">Modifier</button>
                    </div>` : "";

                container.innerHTML += `
                    <div class="product-card" id="prod-${p.id}">
                        <img src="${p.image_url || 'https://via.placeholder.com/200'}" alt="${p.name}">
                        <div class="product-info">
                            <span class="brand">${p.brand}</span>
                            <h3>${p.name}</h3>
                            <span class="price">${p.price.toFixed(2)} ‚Ç¨</span>
                            <button class="add-btn" onclick="addToCart('${pJson}')">Ajouter au panier</button>
                            ${adminButtons}
                        </div>
                    </div>`;
            });
        }
        updateCartUI();
    }

    // --- FONCTIONS ADMIN ---
    async function editProduct(id) {
        const { data: p } = await supabaseClient.from('products').select('*').eq('id', id).single();
        if (p) {
            document.getElementById('edit-id').value = p.id;
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-price').value = p.price;
            document.getElementById('edit-image').value = p.image_url;
            document.getElementById('editModal').style.display = 'flex';
        }
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }

    async function saveEdit() {
        const id = document.getElementById('edit-id').value;
        const { error } = await supabaseClient.from('products').update({
            name: document.getElementById('edit-name').value,
            price: parseFloat(document.getElementById('edit-price').value),
            image_url: document.getElementById('edit-image').value
        }).eq('id', id);

        if (error) alert("Erreur : " + error.message);
        else { closeModal(); loadProducts(); }
    }

    async function deleteProduct(id) {
        if (confirm("‚ö†Ô∏è Confirmer la suppression ?")) {
            const { error } = await supabaseClient.from('products').delete().eq('id', id);
            if (!error) document.getElementById(`prod-${id}`).remove();
            else alert("Erreur lors de la suppression");
        }
    }

    async function logout() { await supabaseClient.auth.signOut(); window.location.reload(); }

    loadProducts();
</script>
</body>
</html>

