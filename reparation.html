<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réparation - PHONE&CO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --violet: #6f42c1; --dark: #333; --light: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin:0; }
        nav { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; display: flex; gap: 40px; }
        .selection-area { flex: 2; }
        .summary-area { flex: 1; }
        .sticky-card { position: sticky; top: 100px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--violet); }
        .grid-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .option-card { background: white; border: 2px solid #eee; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .option-card:hover { border-color: var(--violet); transform: translateY(-3px); }
        .option-card.active { border-color: var(--violet); background: #f3ebff; box-shadow: 0 0 10px rgba(111, 66, 193, 0.2); }
        .option-card img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; }
        h2 { color: var(--violet); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .btn-pdf { width: 100%; background: var(--violet); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-pdf:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<nav>
    <a href="index.html" style="text-decoration:none; color:var(--dark); font-weight:800; font-size:24px;">PHONE&CO</a>
    <div style="display:flex; gap:20px;">
        <a href="accessoires.html" style="text-decoration:none; color:var(--dark);">Accessoires</a>
        <a href="reparation.html" style="color:var(--violet); font-weight:bold; text-decoration:none;">Réparation</a>
    </div>
</nav>

<div class="container">
    <div class="selection-area">
        <h2>1. Choisissez la marque</h2>
        <div id="brands-grid" class="grid-options"></div>
        <h2 id="title-models" style="display:none;">2. Choisissez le modèle</h2>
        <div id="models-grid" class="grid-options"></div>
        <h2 id="title-repairs" style="display:none;">3. Type de problème (Sélection multiple possible)</h2>
        <div id="repairs-grid" class="grid-options"></div>
    </div>

    <div class="summary-area">
        <div class="sticky-card">
            <h3 style="margin-top:0;">Votre Devis Express</h3>
            <p><strong>Marque:</strong> <span id="res-brand">-</span></p>
            <p><strong>Modèle:</strong> <span id="res-model">-</span></p>
            <p><strong>Réparations:</strong> <span id="res-repair">-</span></p>
            <hr>
            <p style="font-size: 22px; color: var(--violet); margin: 10px 0;"><strong>Total : <span id="res-total">0.00</span> €</strong></p>
            <button class="btn-order" id="order-btn" onclick="handleOrder()" style="width: 100%; background: #28a745; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 10px;" disabled>
            PASSER COMMANDE
            </button>
            <button class="btn-pdf" id="pdf-btn" onclick="generatePDF()" disabled>TÉLÉCHARGER LE DEVIS</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://rryfiyupsmdqranvuqmx.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeWZpeXVwc21kcXJhbnZ1cW14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDU5MTcsImV4cCI6MjA4NjgyMTkxN30.JzzAt3ejHhg66unhyw9Fc_uvlvtgJ4h7Pss5TUupD3g";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let selectedBrand = "";
    let selectedModel = "";
    let selectedRepairs = []; 
    let totalPrice = 0;

    async function init() {
        const { data: brands, error } = await supabaseClient.from('repair_brands').select('*');
        const grid = document.getElementById('brands-grid');
        grid.innerHTML = ""; 
        if (brands) {
            brands.forEach(b => {
                grid.innerHTML += `
                    <div class="option-card" onclick="selectBrand(${b.id}, '${b.name}')">
                        <img src="${b.logo_url || 'https://via.placeholder.com/60?text=' + b.name}">
                        <br><span>${b.name}</span>
                    </div>`;
            });
        }
    }

    async function selectBrand(id, name) {
        selectedBrand = name;
        document.getElementById('res-brand').innerText = name;
        document.getElementById('title-models').style.display = 'block';
        
        const { data: models } = await supabaseClient.from('repair_models').select('*').eq('brand_id', id);
        const grid = document.getElementById('models-grid');
        grid.innerHTML = "";
        models.forEach(m => {
            grid.innerHTML += `<div class="option-card" onclick="selectModel('${m.name}')">
                <img src="${m.image_url || 'https://via.placeholder.com/60'}">
                <br><span>${m.name}</span>
            </div>`;
        });
    }

    async function selectModel(name) {
        selectedModel = name;
        document.getElementById('res-model').innerText = name;
        document.getElementById('title-repairs').style.display = 'block';
        
        const { data: repairs } = await supabaseClient.from('repair_types').select('*');
        const grid = document.getElementById('repairs-grid');
        grid.innerHTML = "";
        repairs.forEach(r => {
            grid.innerHTML += `
                <div class="option-card" id="rep-${r.id}" onclick="toggleRepair('${r.name}', ${r.price}, ${r.id})">
                    <span>${r.name}</span>
                    <br><strong style="color:var(--violet)">${r.price.toFixed(2)} €</strong>
                </div>`;
        });
    }

    async function handleOrder() {
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();

        if (!user) {
            alert("Vous devez être connecté pour valider votre commande.");
            localStorage.setItem('pendingOrder', JSON.stringify({
                brand: selectedBrand,
                model: selectedModel,
                repairs: selectedRepairs,
                total: totalPrice
            }));
            window.location.href = "login.html";
            return;
        }

        const btn = document.getElementById('order-btn');
        btn.innerText = "Enregistrement...";
        btn.disabled = true;

        const { error } = await supabaseClient
            .from('orders')
            .insert([{
                user_id: user.id,
                brand: selectedBrand,
                model: selectedModel,
                details: selectedRepairs.map(r => r.name).join(", "),
                total_price: totalPrice,
                status: 'En attente'
            }]);

        if (error) {
            alert("Erreur lors de la commande : " + error.message);
            btn.innerText = "PASSER COMMANDE";
            btn.disabled = false;
        } else {
            alert("✅ Commande envoyée avec succès ! Envoi du récapitulatif par mail...");
            
            // LOGIQUE MAILTO
            const subject = encodeURIComponent(`Confirmation de commande - ${selectedBrand} ${selectedModel}`);
            const body = encodeURIComponent(`Bonjour,\n\nVoici le récapitulatif de votre commande chez PHONE&CO :\n- Appareil : ${selectedBrand} ${selectedModel}\n- Réparations : ${selectedRepairs.map(r => r.name).join(", ")}\n- Prix total : ${totalPrice.toFixed(2)} €\n\nNous vous recontacterons très vite.\n\nCordialement,\nL'équipe PHONE&CO`);
            
            // On envoie le mail à ton adresse admin avec le récap
            window.location.href = `mailto:bap10official@gmail.com?subject=${subject}&body=${body}`;
            
            localStorage.removeItem('pendingOrder');
            // Petit délai pour laisser le temps au mailto de se lancer avant de rediriger
            setTimeout(() => { window.location.href = "index.html"; }, 1000);
        }
    }

    function toggleRepair(name, price, id) {
        const index = selectedRepairs.findIndex(item => item.name === name);
        const element = document.getElementById(`rep-${id}`);

        if (index > -1) {
            selectedRepairs.splice(index, 1);
            totalPrice -= price;
            element.classList.remove('active');
        } else {
            selectedRepairs.push({ name, price });
            totalPrice += price;
            element.classList.add('active');
        }

        const names = selectedRepairs.map(r => r.name).join(", ");
        document.getElementById('res-repair').innerText = names || "-";
        document.getElementById('res-total').innerText = totalPrice.toFixed(2);
        
        const hasSelection = selectedRepairs.length > 0;
        document.getElementById('pdf-btn').disabled = !hasSelection;
        document.getElementById('order-btn').disabled = !hasSelection;
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(111, 66, 193);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("PHONE&CO - DEVIS REPARATION", 20, 25);
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.text(`Appareil : ${selectedBrand} ${selectedModel}`, 20, 60);
        doc.text(`Date : ${new Date().toLocaleDateString('fr-FR')}`, 20, 70);
        doc.line(20, 75, 190, 75);
        doc.text("Détail des interventions :", 20, 85);
        let y = 95;
        selectedRepairs.forEach(r => {
            doc.text(`• ${r.name}`, 25, y);
            doc.text(`${r.price.toFixed(2)} €`, 170, y, { align: 'right' });
            y += 10;
        });
        doc.line(20, y + 5, 190, y + 5);
        doc.setFont(undefined, 'bold');
        doc.setFontSize(16);
        doc.text("TOTAL ESTIMÉ TTC :", 20, y + 20);
        doc.text(`${totalPrice.toFixed(2)} €`, 170, y + 20, { align: 'right' });
        doc.save(`Devis_PhoneCo_${selectedModel.replace(/\s+/g, '_')}.pdf`);
    }

    init();
</script>
</body>
</html>