<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réparation - PHONE&CO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --violet: #6f42c1; --dark: #333; --light: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin:0; }

        /* --- NAVBAR VIOLETTE UNIFORMISÉE --- */
        nav { 
            background: var(--violet); 
            padding: 15px 5%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo { font-weight: 800; font-size: 24px; text-decoration: none; color: white; letter-spacing: 1px; }
        .nav-links { display: flex; gap: 25px; align-items: center; }
        .nav-links a { 
            text-decoration: none; 
            color: rgba(255,255,255,0.9); 
            font-weight: 600; 
            font-size: 13px; 
            text-transform: uppercase; 
            transition: 0.3s;
        }
        .nav-links a:hover { color: white; }
        .nav-links a.active { color: white; border-bottom: 2px solid white; padding-bottom: 5px; }

        /* --- CONTENU --- */
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; display: flex; gap: 40px; flex-wrap: wrap; }
        .selection-area { flex: 2; min-width: 300px; }
        .summary-area { flex: 1; min-width: 300px; }
        
        .sticky-card { position: sticky; top: 100px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--violet); }
        
        .grid-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .option-card { background: white; border: 2px solid #eee; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .option-card:hover { border-color: var(--violet); transform: translateY(-3px); }
        .option-card.active { border-color: var(--violet); background: #f3ebff; box-shadow: 0 0 10px rgba(111, 66, 193, 0.2); }
        .option-card img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; }
        
        h2 { color: var(--violet); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; }
        
        .btn-pdf { width: 100%; background: var(--violet); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .btn-pdf:disabled { background: #ccc; cursor: not-allowed; }
        .btn-pdf:hover:not(:disabled) { opacity: 0.9; }

        .btn-order { width: 100%; background: #28a745; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.3s; }
        .btn-order:disabled { background: #ccc; cursor: not-allowed; }
        .btn-order:hover:not(:disabled) { background: #218838; }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sticky-card { position: relative; top: 0; }
        }
    </style>
</head>
<body>

<nav>
    <a href="index.html" class="logo">PHONE&CO</a>
    <div class="nav-links">
        <a href="accessoires.html">Accessoires</a>
        <a href="reparation.html" class="active">Réparation</a>
        <a href="contact.html">Contact</a>
    </div>
</nav>

<div class="container">
    <div class="selection-area">
        <h2 style="margin-top:0;">1. Choisissez la marque</h2>
        <div id="brands-grid" class="grid-options"></div>
        
        <h2 id="title-models" style="display:none;">2. Choisissez le modèle</h2>
        <div id="models-grid" class="grid-options"></div>
        
        <h2 id="title-repairs" style="display:none;">3. Type de problème (Sélection multiple)</h2>
        <div id="repairs-grid" class="grid-options"></div>
    </div>

    <div class="summary-area">
        <div class="sticky-card">
            <h3 style="margin-top:0; color: var(--dark);">Votre Devis Express</h3>
            <p><strong>Marque:</strong> <span id="res-brand">-</span></p>
            <p><strong>Modèle:</strong> <span id="res-model">-</span></p>
            <p><strong>Réparations:</strong> <span id="res-repair">-</span></p>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <p style="font-size: 22px; color: var(--violet); margin: 10px 0;"><strong>Total : <span id="res-total">0.00</span> €</strong></p>
            
            <button class="btn-order" id="order-btn" onclick="handleOrder()" disabled>
                PASSER COMMANDE
            </button>
            <button class="btn-pdf" id="pdf-btn" onclick="generatePDF()" disabled>
                TÉLÉCHARGER LE DEVIS (PDF)
            </button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://rryfiyupsmdqranvuqmx.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyeWZpeXVwc21kcXJhbnZ1cW14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDU5MTcsImV4cCI6MjA4NjgyMTkxN30.JzzAt3ejHhg66unhyw9Fc_uvlvtgJ4h7Pss5TUupD3g";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let selectedBrand = "";
    let selectedModel = "";
    let selectedRepairs = []; 
    let totalPrice = 0;

    async function init() {
        const { data: brands } = await supabaseClient.from('repair_brands').select('*').order('name');
        const grid = document.getElementById('brands-grid');
        grid.innerHTML = ""; 
        if (brands) {
            brands.forEach(b => {
                grid.innerHTML += `
                    <div class="option-card" id="brand-${b.id}" onclick="selectBrand(${b.id}, '${b.name}')">
                        <img src="${b.logo_url || 'https://via.placeholder.com/60?text=' + b.name}">
                        <br><span>${b.name}</span>
                    </div>`;
            });
        }
    }

    // FONCTION CORRIGÉE : Gère le clic sur la marque et nettoie tout
    async function selectBrand(brandId, brandName) {
        selectedBrand = brandName; // On stocke le nom pour le devis
        
        // 1. Réinitialisation totale des variables
        selectedModel = "";
        selectedRepairs = [];
        totalPrice = 0;

        // 2. Mise à jour visuelle immédiate du résumé (Devis Express)
        document.getElementById('res-brand').innerText = brandName;
        document.getElementById('res-model').innerText = "-";
        document.getElementById('res-repair').innerText = "-";
        document.getElementById('res-total').innerText = "0.00";
        
        // Désactiver les boutons car on a changé de marque
        document.getElementById('order-btn').disabled = true;
        document.getElementById('pdf-btn').disabled = true;

        // 3. Gestion visuelle des grilles
        document.getElementById('title-models').style.display = 'block';
        document.getElementById('models-grid').innerHTML = '<p>Chargement des modèles...</p>';
        document.getElementById('title-repairs').style.display = 'none';
        document.getElementById('repairs-grid').innerHTML = '';

        // Gérer la classe "active" sur les logos de marque
        document.querySelectorAll('#brands-grid .option-card').forEach(el => el.classList.remove('active'));
        const activeCard = document.querySelector(`[onclick*="selectBrand(${brandId}"]`);
        if(activeCard) activeCard.classList.add('active');

        // 4. Charger les modèles de cette marque
        loadModels(brandId);
    }

    // LA FONCTION QUI MANQUAIT
    async function loadModels(brandId) {
        const { data: models } = await supabaseClient
            .from('repair_models')
            .select('*')
            .eq('brand_id', brandId)
            .order('name');

        const grid = document.getElementById('models-grid');
        grid.innerHTML = "";
        
        if (models && models.length > 0) {
            models.forEach(m => {
                grid.innerHTML += `
                    <div class="option-card" onclick="selectModel('${m.name}', ${m.id})">
                        <img src="${m.image_url || 'https://via.placeholder.com/60?text=' + m.name}">
                        <br><span>${m.name}</span>
                    </div>`;
            });
        } else {
            grid.innerHTML = "<p>Aucun modèle disponible pour cette marque.</p>";
        }
    }

    async function selectModel(modelName, modelId) {
        selectedModel = modelName;
        
        // Mise à jour du résumé
        document.getElementById('res-model').innerText = modelName;
        
        // Reset des réparations si on change de modèle
        selectedRepairs = [];
        totalPrice = 0;
        document.getElementById('res-repair').innerText = "-";
        document.getElementById('res-total').innerText = "0.00";

        // Affichage de la grille des pannes
        document.getElementById('title-repairs').style.display = 'block';
        const grid = document.getElementById('repairs-grid');
        grid.innerHTML = "<p>Chargement des tarifs...</p>";

        // Gérer la classe active sur les modèles
        document.querySelectorAll('#models-grid .option-card').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // Charger les pannes liées à ce modèle précis (model_id)
        const { data: repairs } = await supabaseClient
            .from('repair_types')
            .select('*')
            .eq('model_id', modelId);

        grid.innerHTML = "";
        if (repairs && repairs.length > 0) {
            repairs.forEach(r => {
                grid.innerHTML += `
                    <div class="option-card" id="rep-${r.id}" onclick="toggleRepair('${r.name}', ${r.price}, ${r.id})">
                        <span>${r.name}</span>
                        <br><strong style="color:var(--violet)">${r.price.toFixed(2)} €</strong>
                    </div>`;
            });
        } else {
            grid.innerHTML = "<p>Aucun tarif disponible pour ce modèle.</p>";
        }
        
        document.getElementById('title-repairs').scrollIntoView({ behavior: 'smooth' });
    }

    function toggleRepair(name, price, id) {
        const index = selectedRepairs.findIndex(item => item.name === name);
        const element = document.getElementById(`rep-${id}`);

        if (index > -1) {
            selectedRepairs.splice(index, 1);
            totalPrice -= price;
            element.classList.remove('active');
        } else {
            selectedRepairs.push({ name, price });
            totalPrice += price;
            element.classList.add('active');
        }

        // Mise à jour du résumé
        document.getElementById('res-repair').innerText = selectedRepairs.map(r => r.name).join(", ") || "-";
        document.getElementById('res-total').innerText = totalPrice.toFixed(2);
        
        // Activer/Désactiver boutons
        const hasRepairs = selectedRepairs.length > 0;
        document.getElementById('pdf-btn').disabled = !hasRepairs;
        document.getElementById('order-btn').disabled = !hasRepairs;
    }

    async function handleOrder() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            alert("Veuillez vous connecter pour valider votre commande.");
            window.location.href = "login.html";
            return;
        }

        const btn = document.getElementById('order-btn');
        btn.innerText = "Traitement...";
        btn.disabled = true;

        const { error } = await supabaseClient
            .from('orders')
            .insert([{
                user_id: user.id,
                brand: selectedBrand,
                model: selectedModel,
                details: selectedRepairs.map(r => r.name).join(", "),
                total_price: totalPrice,
                status: 'En attente'
            }]);

        if (error) {
            alert("Erreur : " + error.message);
            btn.innerText = "PASSER COMMANDE";
            btn.disabled = false;
        } else {
            alert("✅ Commande enregistrée !");
            window.location.href = `mailto:bap10official@gmail.com?subject=Commande ${selectedBrand}&body=Recap: ${selectedModel} - ${totalPrice}€`;
        }
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(111, 66, 193);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("PHONE&CO - DEVIS", 20, 25);
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.text(`Appareil : ${selectedBrand} ${selectedModel}`, 20, 60);
        doc.text(`Date : ${new Date().toLocaleDateString()}`, 20, 70);
        let y = 90;
        selectedRepairs.forEach(r => {
            doc.text(`• ${r.name}`, 25, y);
            doc.text(`${r.price.toFixed(2)} €`, 170, y, { align: 'right' });
            y += 10;
        });
        doc.setFont("helvetica", "bold");
        doc.text(`TOTAL TTC : ${totalPrice.toFixed(2)} €`, 20, y + 10);
        doc.save(`Devis_${selectedModel}.pdf`);
    }

    init();
</script>
</body>
</html>


